<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据仪表盘 - 虚拟交易平台</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            color: #7f8c8d;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .chart-container h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }
        
        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            float: right;
            margin-bottom: 20px;
        }
        
        .refresh-btn:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <header>
        <h1>虚拟交易平台数据仪表盘</h1>
        <nav>
            <ul>
                <li><a href="/admin/panel">管理后台</a></li>
                <li><a href="/client/dashboard">用户仪表板</a></li>
                <li><a href="/mobile">移动端</a></li>
            </ul>
        </nav>
    </header>
    
    <main class="dashboard-container">
        <button class="refresh-btn" onclick="loadDashboardData()">刷新数据</button>
        
        <div id="dashboard-content">
            <div class="loading">
                <p>正在加载仪表盘数据...</p>
            </div>
        </div>
    </main>
    
    <script>
        // 页面加载时获取数据
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });
        
        // 加载仪表盘数据
        function loadDashboardData() {
            fetch('/api/dashboard/data')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderDashboard(data.data);
                    } else {
                        document.getElementById('dashboard-content').innerHTML = 
                            '<div class="loading"><p>加载数据失败: ' + data.message + '</p></div>';
                    }
                })
                .catch(error => {
                    document.getElementById('dashboard-content').innerHTML = 
                        '<div class="loading"><p>加载数据时出错: ' + error.message + '</p></div>';
                });
        }
        
        // 渲染仪表盘
        function renderDashboard(data) {
            const content = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>总用户数</h3>
                        <div class="value">${data.tradingStats.userCount}</div>
                    </div>
                    <div class="stat-card">
                        <h3>总交易数</h3>
                        <div class="value">${data.tradingStats.tradeCount}</div>
                    </div>
                    <div class="stat-card">
                        <h3>总持仓数</h3>
                        <div class="value">${data.tradingStats.positionCount}</div>
                    </div>
                    <div class="stat-card">
                        <h3>今日交易</h3>
                        <div class="value">${data.tradingStats.todayTradeCount}</div>
                    </div>
                    <div class="stat-card">
                        <h3>活跃用户</h3>
                        <div class="value">${data.tradingStats.activeUserCount}</div>
                    </div>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-container">
                        <h2>资产分布</h2>
                        <canvas id="assetDistributionChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h2>交易趋势</h2>
                        <canvas id="tradingTrendChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h2>用户排名</h2>
                    <canvas id="userRankingsChart"></canvas>
                </div>
            `;
            
            document.getElementById('dashboard-content').innerHTML = content;
            
            // 渲染图表
            renderCharts(data);
        }
        
        // 渲染图表
        function renderCharts(data) {
            // 资产分布图表
            const assetCtx = document.getElementById('assetDistributionChart').getContext('2d');
            new Chart(assetCtx, {
                type: 'pie',
                data: {
                    labels: data.assetDistribution.map(item => item.asset),
                    datasets: [{
                        data: data.assetDistribution.map(item => item.total_quantity),
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#FF9F40',
                            '#FF6384',
                            '#C9CBCF',
                            '#4BC0C0',
                            '#FF6384'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
            
            // 交易趋势图表
            const trendCtx = document.getElementById('tradingTrendChart').getContext('2d');
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: data.tradingTrend.map(item => item.date),
                    datasets: [{
                        label: '交易量',
                        data: data.tradingTrend.map(item => item.trade_count),
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // 用户排名图表
            const rankingCtx = document.getElementById('userRankingsChart').getContext('2d');
            new Chart(rankingCtx, {
                type: 'bar',
                data: {
                    labels: data.userRankings.map(item => item.username),
                    datasets: [{
                        label: '总价值',
                        data: data.userRankings.map(item => item.total_value || 0),
                        backgroundColor: '#4BC0C0'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>